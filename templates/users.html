<!doctype html>
<html lang="en" data-bs-theme="dark">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>VPN User Manager - Users</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
		integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
	<link href="{{ url_for('static', filename='css/vanilla-dataTables.css') }}" rel="stylesheet">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
	<meta name="theme-color" content="#712cf9">
	<style>
		html,
		body {
			height: 100%;
		}
		.checkbox-group {
			max-height: 200px;
			overflow-y: auto;
			border: 1px solid #dee2e6;
			padding: 10px;
			border-radius: 4px;
		}

		.form-check {
			margin-bottom: 8px;
		}
	</style>
</head>

<body class="d-flex">
	<main class="w-100">
		<nav class="navbar navbar-light px-4" style="background-color: #535a9b;" justify-content-between">
			<a class="navbar-brand">Bem vindo! Você está logado como <b>{{ username }}</b>.</a>
			<a class="btn btn-danger my-2 my-sm-0" href="/logout"><i class="fas fa-sign-out-alt"></i> Sair</a>
		</nav>
		<div class="container">
			<div class="row">
				<div class="col-md-10 offset-md-1 mt-3">
					<h3> Tabela de usuários</h3>
					<hr>
					
					<button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#staticBackdrop">
						<i class="fas fa-plus"></i> Adicionar usuário
					</button>

					<hr>
					<table id="table">
						<thead>
							<tr>
								<th scope="col">#</th>
								<th scope="col">Usuário</th>
								<th scope="col">Grupo</th>
								<th scope="col">Status</th>
								<th scope="col" class="text-center">Ações</th>
							</tr>
						</thead>
						<tbody id="usuariosTb">
						</tbody>
					</table>
				</div>
			</div>
		</div>
	</main>

	<!-- Modal Create User-->
	<div class="modal fade" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h1 class="modal-title fs-5" id="staticBackdropLabel">Criar usuário</h1>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<form id="addUserForm">
						<div class="form-group">
							<label for="user">Usuário</label>
							<input type="text" class="form-control" id="user" name="user" required>
						</div>
						<div class="form-group">
							<label for="pass">Senha</label>
							<div class="input-group">
								<input type="password" class="form-control" id="pass" name="pass" required>
								<button type="button" class="btn btn-secondary" onclick="gerarSenha()">
									<i class="fas fa-dice"></i> Gerar Senha
								</button>
							</div>
						</div>
						<div class="form-group">
							<label>Empresas</label>
							<div id="groupCheckboxes" class="checkbox-group">
								<!-- Checkboxes serão inseridos aqui via JavaScript -->
							</div>
						</div>
					</form>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><i class="fas fa-times"></i> Cancelar</button>
					<button type="button" class="btn btn-primary" onclick="addUser()"><i class="fas fa-plus"></i> Criar</button>
				</div>
			</div>
		</div>
	</div>

	<!-- Modal Change Password-->
	<div class="modal fade" id="change_password_modal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h1 class="modal-title fs-5" id="staticBackdropLabel">Mudar senha</h1>
				</div>
				<div class="modal-body">
					<div class="form-group">
						<label for="user">Usuário</label>
						<input type="text" class="form-control" id="change_password_user" name="user" required disabled>
						<label for="pass">Senha</label>
						<input type="password" class="form-control" id="change_password_pass" name="pass" required>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><i class="fas fa-times"></i> Cancelar</button>
					<button type="button" class="btn btn-primary" onclick="change_password()"><i class="fas fa-check"></i> Mudar</button>
				</div>
			</div>
		</div>
	</div>

	<!-- Modal Change Group-->
	<div class="modal fade" id="change_group_modal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h1 class="modal-title fs-5" id="staticBackdropLabel">Mudar grupos</h1>
				</div>
				<div class="modal-body">
					<div class="form-group">
						<label for="user">Usuário</label>
						<input type="text" class="form-control" id="change_group_user" name="user" required disabled>
						<label class="mt-3">Grupos</label>
						<div id="groups_checkboxes" class="mt-2">
							<!-- Checkboxes serão inseridos aqui via JavaScript -->
						</div>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><i class="fas fa-times"></i> Cancelar</button>
					<button type="button" class="btn btn-primary" onclick="change_group()"><i class="fas fa-check"></i> Mudar</button>
				</div>
			</div>
		</div>
	</div>

	<!-- Bootstrap and SweetAlert2 and DataTables -->
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
		integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
		crossorigin="anonymous">
	</script>
	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
	<script src="{{ url_for('static', filename='js/vanilla-dataTables.js')}}"></script>
	
	<script>
		// Global variables
		document.addEventListener("DOMContentLoaded", function () {
			// Carrega os usuários
			fetch('/get_users')
				.then(response => response.json())
				.then(users => {
					const tbody = document.getElementById('usuariosTb');
					tbody.innerHTML = '';
					
					users.forEach((usuario, index) => {
						const row = document.createElement('tr');

						// Número do usuário
						const numberCell = document.createElement('th');
						numberCell.scope = "row";
						numberCell.textContent = index + 1;

						// Célula do usuário
						const userCell = document.createElement('td');
						userCell.textContent = usuario.username;

						// Célula dos grupos/empresas
						const groupsCell = document.createElement('td');
						groupsCell.textContent = usuario.groups.join(', ');

						// Status do usuário
						const statusCell = document.createElement('td');
						const statusIcon = document.createElement('i');
						const statusText = document.createElement('span');
						if (usuario.active) {
							statusIcon.classList = "fas fa-check";
							statusText.textContent = " Ativo";
							statusCell.classList = "text-success";
						} else {
							statusIcon.classList = "fas fa-times";
							statusText.textContent = " Inativo";
							statusCell.classList = "text-danger";
						}
						statusCell.appendChild(statusIcon);
						statusCell.appendChild(statusText);

						// Ações
						const actionsCell = document.createElement('td');
						actionsCell.classList = "d-flex justify-content-center";
						actionsCell.innerHTML = `
							<div class="btn-group w-100" role="group" aria-label="Basic example">
								<button type="button" class="btn btn-primary" style="width: 125px" onclick="change_password_modal('${usuario.username}')">
									<i class="fas fa-key"></i> Trocar senha
								</button>
								<button type="button" class="btn btn-warning" style="width: 125px" onclick="change_group_modal('${usuario.username}')">
									<i class="fas fa-users"></i> Mudar grupo
								</button>
								${usuario.active ? 
									`<button type="button" class="btn btn-secondary" style="width: 125px" onclick="lock_user('${usuario.username}')">
										<i class="fas fa-lock"></i> Desabilitar
									</button>` :
									`<button type="button" class="btn btn-success" style="width: 125px" onclick="unlock_user('${usuario.username}')">
										<i class="fas fa-unlock"></i> Ativar
									</button>`
								}
								<button type="button" class="btn btn-danger" style="width: 125px" onclick="delete_user('${usuario.username}')">
									<i class="fas fa-trash"></i> Deletar
								</button>
							</div>`;

						// Adiciona as células à linha
						row.appendChild(numberCell);
						row.appendChild(userCell);
						row.appendChild(groupsCell);
						row.appendChild(statusCell);
						row.appendChild(actionsCell);

						// Adiciona a linha ao tbody
						tbody.appendChild(row);
					});

					// Inicializa o DataTable
					var table = document.getElementById('table');
					var options = {
						perPage: 10,
					};
					var dataTable = new DataTable(table, options);
				})
				.catch(error => console.error('Erro ao buscar usuários:', error));
		
			// Carrega os grupos para o modal de criação
			loadGroups();
		})

		// Modals invocations
		function change_password_modal(user) {
			const modal = new bootstrap.Modal('#change_password_modal')
			document.getElementById('change_password_user').value = user;
			modal.show();
		}

		function change_group_modal(username) {
			const modal = new bootstrap.Modal('#change_group_modal');
			document.getElementById('change_group_user').value = username;
			
			// Limpa os checkboxes existentes
			const groupsContainer = document.getElementById('groups_checkboxes');
			groupsContainer.innerHTML = '';
			
			// Busca os grupos do usuário
			fetch('/get_users')
				.then(response => response.json())
				.then(users => {
					const user = users.find(u => u.username === username);
					const userGroups = user ? user.groups : [];
					
					// Busca todos os grupos disponíveis
					fetch('/get_groups')
						.then(response => response.json())
						.then(groups => {
							groups.forEach(group => {
								const div = document.createElement('div');
								div.className = 'form-check';
								
								const input = document.createElement('input');
								input.type = 'checkbox';
								input.className = 'form-check-input';
								input.id = `group_${group}`;
								input.name = 'groups[]';
								input.value = group;
								input.checked = userGroups.includes(group);
								
								const label = document.createElement('label');
								label.className = 'form-check-label';
								label.htmlFor = `group_${group}`;
								label.textContent = group;
								
								div.appendChild(input);
								div.appendChild(label);
								groupsContainer.appendChild(div);
							});
						});
				});
			
			modal.show();
		}

		// Functions
		function addUser() {
			const user = document.getElementById('user').value;
			const pass = document.getElementById('pass').value;
			const selectedGroups = Array.from(document.querySelectorAll('input[name="groups"]:checked'))
				.map(checkbox => checkbox.value);

			if (selectedGroups.length === 0) {
				Swal.fire({
					icon: 'error',
					title: 'Erro',
					text: 'Selecione pelo menos uma empresa'
				});
				return;
			}

			const formData = new FormData();
			formData.append('user', user);
			formData.append('pass', pass);
			formData.append('groups', selectedGroups.join(','));

			fetch('/add_user', {
				method: 'POST',
				body: formData
			})
			.then(response => response.json())
			.then(data => {
				if (data.success) {
					Swal.fire({
						icon: 'success',
						title: 'Sucesso',
						text: data.message
					}).then(() => {
						window.location.reload();
					});
				} else {
					Swal.fire({
						icon: 'error',
						title: 'Erro',
						text: data.message
					});
				}
			});
		}

		function change_password() {
			console.log('change_password');
			const change_password_user = document.getElementById('change_password_user').value;
			const change_password_pass = document.getElementById('change_password_pass').value;
			if (!change_password_user || !change_password_pass) {
				alert('Por favor, preencha todos os campos');
				return;
			}
			fetch('/change_password', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
				},
				body: JSON.stringify({
					change_password_user: change_password_user,
					change_password_pass: change_password_pass
				})
			})
			.then(response => response.json())
			.then(data => {
				if (data.success) {
					Swal.fire({
						title: 'Senha alterada com sucesso',
						icon: 'success',
						timer: 2000,
						showConfirmButton: false
					}).then(() => {
						window.location.reload();
					});
				} else {
					Swal.fire({
						title: 'Erro ao alterar senha',
						icon: 'error',
						timer: 2000,
						showConfirmButton: false
					});
				}
			})
			.catch(error => console.error('Erro ao trocar senha:', error));
		}

		function change_group() {
			const username = document.getElementById('change_group_user').value;
			const selectedGroups = Array.from(document.querySelectorAll('input[name="groups[]"]:checked'))
				.map(checkbox => checkbox.value);
			
			if (!username || selectedGroups.length === 0) {
				Swal.fire({
					title: 'Erro',
					text: 'Selecione pelo menos um grupo',
					icon: 'error',
					timer: 2000,
					showConfirmButton: false
				});
				return;
			}
			
			fetch('/change_group', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
				},
				body: JSON.stringify({
					change_group_user: username,
					change_group_groups: selectedGroups
				})
			})
			.then(response => response.json())
			.then(data => {
				if (data.success) {
					Swal.fire({
						title: 'Grupos alterados com sucesso',
						icon: 'success',
						timer: 2000,
						showConfirmButton: false
					}).then(() => {
						window.location.reload();
					});
				} else {
					Swal.fire({
						title: 'Erro ao alterar grupos',
						icon: 'error',
						timer: 2000,
						showConfirmButton: false
					});
				}
			})
			.catch(error => console.error('Erro ao alterar grupos:', error));
		}
		
		function lock_user(username) {
			Swal.fire({
				title: 'Desativar usuário',
				html: `Deseja realmente desativar o usuário <b>${username}</b>?`,
				icon: 'warning',
				showCancelButton: true,
				confirmButtonText: 'Sim, desativar',
				cancelButtonText: 'Cancelar'
			}).then((result) => {
				if (result.isConfirmed) {
					fetch('/lock_user', {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json',
						},
						body: JSON.stringify({
							user_to_lock: username
						})
					})
					.then(response => response.json())
					.then(data => {
						if (data.success) {
							Swal.fire({
								title: 'Usuário bloqueado com sucesso',
								icon: 'success',
								timer: 2000,
								showConfirmButton: false
							}).then(() => {
								window.location.reload();
							});
						} else {
							Swal.fire({
								title: 'Erro ao bloquear usuário',
								icon: 'error',
								timer: 2000,
								showConfirmButton: false
							});
						}
					})
					.catch(error => console.error('Erro ao bloquear usuário:', error));
				}
			});
		}
		
		function unlock_user(username) {
			Swal.fire({
				title: 'Ativar usuário',
				html: `Deseja realmente ativar o usuário <b>${username}</b>?`,
				icon: 'warning',
				showCancelButton: true,
				confirmButtonText: 'Sim, ativar',
				cancelButtonText: 'Cancelar'
			}).then((result) => {
				if (result.isConfirmed) {
					fetch('/unlock_user', {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json',
						},
						body: JSON.stringify({
							user_to_unlock: username
						})
					})
					.then(response => response.json())
					.then(data => {
						if (data.success) {
							Swal.fire({
								title: 'Usuário ativado com sucesso',
								icon: 'success',
								timer: 2000,
								showConfirmButton: false
							}).then(() => {
								window.location.reload();
							});
						}
					})	
					.catch(error => console.error('Erro ao ativar usuário:', error));
				}
			});
		}	

		function delete_user(username) {
			Swal.fire({
				title: 'Deletar usuário',
				html: `Deseja realmente deletar o usuário <b>${username}</b>?`,
				icon: 'warning',
				showCancelButton: true,
				confirmButtonText: 'Sim, deletar',
				cancelButtonText: 'Cancelar'
			}).then((result) => {
				if (result.isConfirmed) {
					fetch('/remove_user', {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json',
						},
						body: JSON.stringify({
							user_to_delete: username
						})
					})
					.then(response => response.json())
					.then(data => {
						if (data.success) {
							Swal.fire({
								title: 'Usuário deletado com sucesso',
								icon: 'success',
								timer: 2000,
								showConfirmButton: false
							}).then(() => {
								window.location.reload();
							});
						}
					})
					.catch(error => console.error('Erro ao deletar usuário:', error));
				}
			});
		}

		function gerarSenha() {
			const caracteres = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
			const tamanhoSenha = 8;
			let senha = '';
			
			// Garante pelo menos um número
			senha += '0123456789'.charAt(Math.floor(Math.random() * 10));
			
			// Garante pelo menos uma letra maiúscula
			senha += 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.charAt(Math.floor(Math.random() * 26));
			
			// Completa o resto da senha
			for (let i = senha.length; i < tamanhoSenha; i++) {
				senha += caracteres.charAt(Math.floor(Math.random() * caracteres.length));
			}
			
			// Embaralha a senha
			senha = senha.split('').sort(() => Math.random() - 0.5).join('');
			
			// Atualiza o campo de senha
			document.getElementById('pass').value = senha;
			
			// Mostra a senha gerada em um alerta
			Swal.fire({
				title: 'Senha Gerada',
				text: senha,
				icon: 'info',
				confirmButtonText: 'Copiar e Fechar',
			}).then((result) => {
				if (result.isConfirmed) {
					navigator.clipboard.writeText(senha);
					Swal.fire({
						title: 'Senha Copiada!',
						icon: 'success',
						timer: 1500,
						showConfirmButton: false
					});
				}
			});
		}

		function loadGroups() {
			fetch('/get_groups')
				.then(response => response.json())
				.then(groups => {
					const groupCheckboxes = document.getElementById('groupCheckboxes');
					groupCheckboxes.innerHTML = ''; // Limpa os checkboxes existentes
					
					groups.forEach(group => {
						const div = document.createElement('div');
						div.className = 'form-check';
						
						div.innerHTML = `
							<input class="form-check-input" type="checkbox" name="groups" value="${group}" id="group_${group}">
							<label class="form-check-label" for="group_${group}">
								${group}
							</label>
						`;
						
						groupCheckboxes.appendChild(div);
					});
				});
		}

	</script>
</body>

</html>