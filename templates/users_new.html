<!doctype html>
<html lang="pt-br">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>VPN User Manager - Users</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
		integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
	<link href="{{ url_for('static', filename='css/vanilla-dataTables.css') }}" rel="stylesheet">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

	<style>
		/* Página inteira com fundo espacial (match com login) */
		html, body {
			min-height: 100vh;
			height: 100%;
			margin: 0;
			font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
			background: radial-gradient(circle at top, #1a2a6c, #0b132b 60%, #000000 100%);
			background-attachment: fixed;
			background-repeat: no-repeat;
			background-size: cover;
			color: #e6eef8;
		}

		/* Navbar futurista */
		.navbar-future {
			background: rgba(10, 15, 30, 0.55);
			backdrop-filter: blur(10px);
			-webkit-backdrop-filter: blur(10px);
			border-bottom: 1px solid rgba(0,183,255,0.18);
			box-shadow: 0 6px 24px rgba(0,183,255,0.06);
			padding: 0.6rem 1rem;
		}
		.navbar-future .navbar-brand {
			color: #e0eaff;
			font-weight: 700;
			letter-spacing: .6px;
		}
		.navbar-future .btn {
			font-weight: 700;
		}

		/* Card principal que envolve o conteúdo (reskin preserving layout) */
		.container-card {
			max-width: 1100px;
			margin: 2.2rem auto;
			padding: 1.3rem;
			background: rgba(12, 17, 30, 0.66);
			border-radius: 14px;
			border: 1px solid rgba(0,183,255,0.12);
			box-shadow: 0 12px 40px rgba(0,183,255,0.06);
			backdrop-filter: blur(8px);
			-webkit-backdrop-filter: blur(8px);
		}

		h3 {
			color: #e6eef8;
			font-weight: 700;
			letter-spacing: .6px;
		}

		/* Inputs and form controls - match login style */
		.form-control {
			border-radius: 12px;
			padding: .7rem .75rem;
			background: rgba(255,255,255,0.02);
			border: 1px solid rgba(0,183,255,0.16);
			color: #fff;
		}
		.form-control::placeholder { color: rgba(200,220,255,0.5); }
		.form-control:focus {
			background: rgba(0,0,0,0.35);
			border-color: #00b7ff;
			box-shadow: 0 0 12px rgba(0,183,255,0.25);
			color: #fff;
		}

		/* Botões - redefinições para o tema */
		.btn-custom {
			background: linear-gradient(90deg, #00b7ff, #004b8d);
			border: none;
			border-radius: 10px;
			font-weight: 700;
			padding: .55rem .9rem;
			transition: transform .15s ease, box-shadow .15s ease;
			color: #fff;
			letter-spacing: .4px;
			text-transform: none;
		}
		.btn-custom:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(0,183,255,0.12); }

		/* Mapear classes bootstrap padrão para o visual futurista sem alterar JS */
		.btn-primary {
			background: linear-gradient(90deg, #0ea5ff, #0077b6);
			border: 1px solid rgba(0,183,255,0.22);
			color: #fff;
			border-radius: 10px;
			box-shadow: none;
		}
		.btn-primary:hover { box-shadow: 0 10px 28px rgba(0,183,255,0.12); transform: translateY(-2px); }

		.btn-warning {
			background: linear-gradient(90deg, #ffa94d, #d97706);
			border: 1px solid rgba(255,165,77,0.14);
			color: #1b1b1b;
			border-radius: 10px;
		}

		.btn-danger {
			background: linear-gradient(90deg, #ff6b6b, #d43f3f);
			border: 1px solid rgba(255,107,107,0.12);
			color: #fff;
			border-radius: 10px;
		}

		.btn-success {
			background: linear-gradient(90deg, #4ade80, #16a34a);
			border: 1px solid rgba(74,222,128,0.12);
			color: #0b0b0b;
			border-radius: 10px;
		}

		.btn-secondary {
			background: linear-gradient(90deg, #94a3b8, #475569);
			border: 1px solid rgba(148,163,184,0.08);
			color: #fff;
			border-radius: 10px;
		}

		/* Tabela */
		table#table {
			width: 100%;
			border-collapse: collapse;
			background: rgba(255,255,255,0.02);
			color: #e6eef8;
			border-radius: 8px;
			overflow: hidden;
		}
		table#table thead th {
			background: rgba(0,0,0,0.30);
			border-bottom: 1px solid rgba(0,183,255,0.06);
			color: #dbeafe;
			font-weight: 700;
			padding: .8rem;
		}
		table#table tbody td, table#table tbody th {
			padding: .65rem;
			vertical-align: middle;
			border-bottom: 1px solid rgba(255,255,255,0.03);
		}

		/* Ações - ajusta botão agrupado para ficar responsivo */
		.btn-group .btn {
			padding-left: .6rem;
			padding-right: .6rem;
			font-size: .9rem;
		}

		/* Modal styling - aplicar tema futurista */
		.modal-content {
			background: #0f2233; /* cor sólida levemente clara, sem transparência */
			border-radius: 12px;
			border: 1px solid rgba(0,183,255,0.12);
			box-shadow: 0 30px 80px rgba(0,183,255,0.06);
			color: #e6eef8;
		}
		/* Escurece o backdrop para destacar o modal */
		.modal-backdrop.show {
			background-color: rgba(0, 0, 0, 0.55);
		}
		.modal-header, .modal-footer {
			border: none;
			padding: .9rem 1.25rem;
		}
		.modal-body {
			padding: 1rem 1.25rem;
		}
		.modal-title {
			color: #e6eef8;
			font-weight: 700;
		}

		/* Checkbox group box */
		.checkbox-group {
			max-height: 200px;
			overflow-y: auto;
			border: 1px solid rgba(0,183,255,0.08);
			padding: 10px;
			border-radius: 8px;
			background: rgba(255,255,255,0.01);
		}
		.form-check-label {
			color: #e6eef8;
		}

		/* Flash messages small style */
		.flash-message {
			margin-top: 1rem;
			font-size: .95rem;
			color: #ffcccb;
			text-align: center;
		}

		/* Responsividade */
		@media (max-width: 768px) {
			.container-card { margin: 1rem; padding: 1rem; }
			.btn-group .btn { font-size: .8rem; padding: .4rem .5rem; }
		}
	</style>
</head>

<body>
	<!-- Navbar -->
	<nav class="navbar navbar-expand-lg navbar-future">
		<div class="container-fluid">
			<span class="navbar-brand">
				<a class="navbar-brand" href="#">
					<img src="{{ url_for('static', filename='img/brand.png') }}" alt="Logo do sistema" class="rounded" width="32" height="34">
				</a>
				Bem vindo! Você está logado como <b>{{ username }}</b>.
			</span>
			<div class="d-flex">
				<button type="button" class="btn btn-custom mx-2" data-bs-toggle="modal" data-bs-target="#change_genpass_modal">
						<i class="fas fa-plus"></i> GenPass Config
				</button>
				<a class="btn btn-danger" href="/logout"><i class="fas fa-sign-out-alt"></i> Sair</a>
			</div>
		</div>
	</nav>

	<main class="container-card">
		<div class="row">
			<div class="col-12">
				<div class="d-flex justify-content-between align-items-center mb-3">
					<h3>Tabela de usuários</h3>
					<button type="button" class="btn btn-custom" data-bs-toggle="modal" data-bs-target="#staticBackdrop">
						<i class="fas fa-plus"></i> Adicionar usuário
					</button>
				</div>

				<hr style="border-color: rgba(0,183,255,0.06)">

				<div class="table-responsive">
					<table id="table" class="table table-borderless">
						<thead>
							<tr>
								<th scope="col">#</th>
								<th scope="col">Usuário</th>
								<th scope="col">Grupo</th>
								<th scope="col">Status</th>
								<th scope="col" class="text-center">Ações</th>
							</tr>
						</thead>
						<tbody id="usuariosTb">
						</tbody>
					</table>
				</div>
			</div>
		</div>
	</main>

	<!-- Modal Admin Users-->
	<div class="modal fade" id="adminsModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="adminsModalLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h1 class="modal-title fs-5" id="adminsModalLabel">Administradores</h1>
					<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<div class="table-responsive">
						<table id="table" class="table table-borderless">
							<thead>
								<tr>
									<th scope="col">Usuário</th>
									<th scope="col">Status</th>
									<th scope="col" class="text-center">Ações</th>
								</tr>
							</thead>
							<tbody id="usuariosTb">
							</tbody>
						</table>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><i class="fas fa-times"></i> Cancelar</button>
					<button type="button" class="btn btn-primary" onclick="addUser()"><i class="fas fa-plus"></i> Criar</button>
				</div>
			</div>
		</div>
	</div>

	<!-- Modal Create User-->
	<div class="modal fade" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h1 class="modal-title fs-5" id="staticBackdropLabel">Criar usuário</h1>
					<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<form id="addUserForm">
						<div class="form-group mb-2">
							<label for="user" class="form-label">Usuário</label>
							<input type="text" class="form-control" id="user" name="user" required>
						</div>
						<div class="form-group mb-2">
							<label for="pass" class="form-label">Senha</label>
							<div class="input-group">
								<input type="password" class="form-control" id="pass" name="pass" required>
								<button type="button" class="btn btn-secondary" onclick="gerarSenha('pass')">
									<i class="fas fa-dice"></i> Gerar Senha
								</button>
							</div>
						</div>
						<div class="form-group">
							<label class="form-label">Empresas</label>
							<div id="groupCheckboxes" class="checkbox-group mt-2">
								<!-- Checkboxes serão inseridos aqui via JavaScript -->
							</div>
						</div>
					</form>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><i class="fas fa-times"></i> Cancelar</button>
					<button type="button" class="btn btn-primary" onclick="addUser()"><i class="fas fa-plus"></i> Criar</button>
				</div>
			</div>
		</div>
	</div>

	<!-- Modal Change Password-->
	<div class="modal fade" id="change_password_modal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h1 class="modal-title fs-5" id="staticBackdropLabel">Mudar senha</h1>
				</div>
				<div class="modal-body">
					<div class="form-group">
						<label for="change_password_user" class="form-label">Usuário</label>
						<input type="text" class="form-control" id="change_password_user" name="user" required disabled>
						<label for="change_password_pass" class="form-label mt-3">Senha</label>
						<div class="input-group">
							<input type="password" class="form-control" id="change_password_pass" name="pass" required>
							<button type="button" class="btn btn-secondary" onclick="gerarSenha('change_password_pass')">
								<i class="fas fa-dice"></i> Gerar Senha
							</button>
						</div>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><i class="fas fa-times"></i> Cancelar</button>
					<button type="button" class="btn btn-primary" onclick="change_password()"><i class="fas fa-check"></i> Mudar</button>
				</div>
			</div>
		</div>
	</div>

	<!-- Modal Change Group-->
	<div class="modal fade" id="change_group_modal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h1 class="modal-title fs-5" id="staticBackdropLabel">Mudar grupos</h1>
				</div>
				<div class="modal-body">
					<div class="form-group">
						<label for="change_group_user" class="form-label">Usuário</label>
						<input type="text" class="form-control" id="change_group_user" name="user" required disabled>
						<label class="mt-3 form-label">Grupos</label>
						<div id="groups_checkboxes" class="mt-2">
							<!-- Checkboxes serão inseridos aqui via JavaScript -->
						</div>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><i class="fas fa-times"></i> Cancelar</button>
					<button type="button" class="btn btn-primary" onclick="change_group()"><i class="fas fa-check"></i> Mudar</button>
				</div>
			</div>
		</div>
	</div>

	<!-- Modal Change GenPass-->
	<div class="modal fade" id="change_genpass_modal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h1 class="modal-title fs-5" id="staticBackdropLabel">Configurar Gerador de Senha</h1>
				</div>
				<div class="modal-body">
					<div class="form-group">
						<label for="pass_gen_range" class="form-label">Número de caracteres:</label>
						<input type="range" class="form-range" min="8" max="24" value="12" id="pass_gen_range">
						<output for="pass_gen_range" id="pass_gen_range_value" aria-hidden="true"></output>
					</div>
					<div class="form-group">
						<div class="form-check">
							<input class="form-check-input" type="checkbox" value="" id="pass_gen_lowercase" checked>
							<label class="form-check-label" for="pass_gen_lowercase">Letras minúsculas</label>
						</div>
						<div class="form-check">
							<input class="form-check-input" type="checkbox" value="" id="pass_gen_uppercase" checked>
							<label class="form-check-label" for="pass_gen_uppercase">Letras maiúsculas</label>
						</div>
						<div class="form-check">
							<input class="form-check-input" type="checkbox" value="" id="pass_gen_numbers" checked>
							<label class="form-check-label" for="pass_gen_numbers">Números</label>
						</div>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><i class="fas fa-times"></i> Cancelar</button>
					<button type="button" class="btn btn-primary" onclick="change_genpass()"><i class="fas fa-check"></i> Mudar</button>
				</div>
			</div>
		</div>
	</div>

	<!-- Bootstrap and SweetAlert2 and DataTables -->
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
		integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
		crossorigin="anonymous"></script>
	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
	<script src="{{ url_for('static', filename='js/vanilla-dataTables.js')}}"></script>

	<script>
		// Global variables
		passGenCaracters = 12;
		passGenLowercase = true;
		passGenUppercase = true;
		passGenNumbers = true;

		const elPassGenRange = document.getElementById('pass_gen_range');
		const elPassGenLowercase = document.getElementById('pass_gen_lowercase');
		const elPassGenUppercase = document.getElementById('pass_gen_uppercase');
		const elPassGenNumbers = document.getElementById('pass_gen_numbers');
		const rangeOutput = document.getElementById('pass_gen_range_value');
		
		document.addEventListener("DOMContentLoaded", function () {
			
			rangeOutput.textContent = elPassGenRange.value;

			elPassGenRange.addEventListener('input', function() {
				rangeOutput.textContent = this.value;
			});
			
			fetch('/get_genpass_config')
				.then(response => response.json())
				.then(config => {
					passGenCaracters = config.length;
					passGenLowercase = config.lowercase;
					passGenUppercase = config.uppercase;
					passGenNumbers = config.numbers;
					elPassGenRange.value = config.length;
					elPassGenLowercase.checked = config.lowercase;
					elPassGenUppercase.checked = config.uppercase;
					elPassGenNumbers.checked = config.numbers;
					rangeOutput.textContent = config.length;
				})
				.catch(error => console.error('Erro ao carregar configuração do gerador de senha:', error));

			// Carrega os usuários
			fetch('/get_users')
				.then(response => response.json())
				.then(users => {
					const tbody = document.getElementById('usuariosTb');
					tbody.innerHTML = '';
					
					users.forEach((usuario, index) => {
						const row = document.createElement('tr');

						// Número do usuário
						const numberCell = document.createElement('th');
						numberCell.scope = "row";
						numberCell.textContent = index + 1;

						// Célula do usuário
						const userCell = document.createElement('td');
						userCell.textContent = usuario.username;

						// Célula dos grupos/empresas
						const groupsCell = document.createElement('td');
						groupsCell.textContent = usuario.groups.join(', ');

						// Status do usuário
						const statusCell = document.createElement('td');
						const statusIcon = document.createElement('i');
						const statusText = document.createElement('span');
						if (usuario.active) {
							statusIcon.classList = "fas fa-check";
							statusText.textContent = " Ativo";
							statusCell.classList = "text-success";
						} else {
							statusIcon.classList = "fas fa-times";
							statusText.textContent = " Inativo";
							statusCell.classList = "text-danger";
						}
						statusCell.appendChild(statusIcon);
						statusCell.appendChild(statusText);

						// Ações
						const actionsCell = document.createElement('td');
						actionsCell.classList = "d-flex justify-content-center";
						actionsCell.innerHTML = `
							<div class="btn-group w-100" role="group" aria-label="Basic example">
								<button type="button" class="btn btn-primary" style="width: 125px" onclick="change_password_modal('${usuario.username}')">
									<i class="fas fa-key"></i> Trocar senha
								</button>
								<button type="button" class="btn btn-warning" style="width: 125px" onclick="change_group_modal('${usuario.username}')">
									<i class="fas fa-users"></i> Mudar grupo
								</button>
								${usuario.active ? 
									`<button type="button" class="btn btn-secondary" style="width: 125px" onclick="lock_user('${usuario.username}')">
										<i class="fas fa-lock"></i> Desabilitar
									</button>` :
									`<button type="button" class="btn btn-success" style="width: 125px" onclick="unlock_user('${usuario.username}')">
										<i class="fas fa-unlock"></i> Ativar
									</button>`
								}
								<button type="button" class="btn btn-danger" style="width: 125px" onclick="delete_user('${usuario.username}')">
									<i class="fas fa-trash"></i> Deletar
								</button>
							</div>`;

						// Adiciona as células à linha
						row.appendChild(numberCell);
						row.appendChild(userCell);
						row.appendChild(groupsCell);
						row.appendChild(statusCell);
						row.appendChild(actionsCell);

						// Adiciona a linha ao tbody
						tbody.appendChild(row);
					});

					// Inicializa o DataTable
					var table = document.getElementById('table');
					var options = {
						perPage: 10,
						perPageSelect: [5, 8, 10, 12, 15]
					};
					var dataTable = new DataTable(table, options);
				})
				.catch(error => console.error('Erro ao buscar usuários:', error));
		
			// Carrega os grupos para o modal de criação
			loadGroups();

			fetch('get_admins')
				.then(response => response.json())
				.then(admins => {
					const adminsModalBody = document.querySelector('#adminsModal .modal-body');
					const adminList = document.createElement('ul');
					admins.forEach(admin => {
						const listItem = document.createElement('li');
						listItem.textContent = admin;
						adminList.appendChild(listItem);
					});
					adminsModalBody.appendChild(adminList);
				});
		})

		// Modals invocations
		function change_password_modal(user) {
			const modal = new bootstrap.Modal('#change_password_modal')
			document.getElementById('change_password_user').value = user;
			modal.show();
		}

		function change_group_modal(username) {
			const modal = new bootstrap.Modal('#change_group_modal');
			document.getElementById('change_group_user').value = username;
			
			// Limpa os checkboxes existentes
			const groupsContainer = document.getElementById('groups_checkboxes');
			groupsContainer.innerHTML = '';
			
			// Busca os grupos do usuário
			fetch('/get_users')
				.then(response => response.json())
				.then(users => {
					const user = users.find(u => u.username === username);
					const userGroups = user ? user.groups : [];
					
					// Busca todos os grupos disponíveis
					fetch('/get_groups')
						.then(response => response.json())
						.then(groups => {
							groups.forEach(group => {
								const div = document.createElement('div');
								div.className = 'form-check';
								
								const input = document.createElement('input');
								input.type = 'checkbox';
								input.className = 'form-check-input';
								input.id = `group_${group}`;
								input.name = 'groups[]';
								input.value = group;
								input.checked = userGroups.includes(group);
								
								const label = document.createElement('label');
								label.className = 'form-check-label';
								label.htmlFor = `group_${group}`;
								label.textContent = group;
								
								div.appendChild(input);
								div.appendChild(label);
								groupsContainer.appendChild(div);
							});
						});
				});
			
			modal.show();
		}

		// Functions
		function addUser() {
			const user = document.getElementById('user').value;
			const pass = document.getElementById('pass').value;
			const selectedGroups = Array.from(document.querySelectorAll('input[name="groups"]:checked'))
				.map(checkbox => checkbox.value);

			if (selectedGroups.length === 0) {
				Swal.fire({
					icon: 'error',
					title: 'Erro',
					text: 'Selecione pelo menos uma empresa'
				});
				return;
			}

			const formData = new FormData();
			formData.append('user', user);
			formData.append('pass', pass);
			formData.append('groups', selectedGroups.join(','));

			fetch('/add_user', {
				method: 'POST',
				body: formData
			})
			.then(response => response.json())
			.then(data => {
				if (data.success) {
					Swal.fire({
						icon: 'success',
						title: 'Sucesso',
						text: data.message
					}).then(() => {
						window.location.reload();
					});
				} else {
					Swal.fire({
						icon: 'error',
						title: 'Erro',
						text: data.message
					});
				}
			});
		}

		function change_password() {
			console.log('change_password');
			const change_password_user = document.getElementById('change_password_user').value;
			const change_password_pass = document.getElementById('change_password_pass').value;
			if (!change_password_user || !change_password_pass) {
				alert('Por favor, preencha todos os campos');
				return;
			}
			fetch('/change_password', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
				},
				body: JSON.stringify({
					change_password_user: change_password_user,
					change_password_pass: change_password_pass
				})
			})
			.then(response => response.json())
			.then(data => {
				if (data.success) {
					Swal.fire({
						title: 'Senha alterada com sucesso',
						icon: 'success',
						timer: 2000,
						showConfirmButton: false
					}).then(() => {
						window.location.reload();
					});
				} else {
					Swal.fire({
						title: 'Erro ao alterar senha',
						icon: 'error',
						timer: 2000,
						showConfirmButton: false
					});
				}
			})
			.catch(error => console.error('Erro ao trocar senha:', error));
		}

		function change_group() {
			const username = document.getElementById('change_group_user').value;
			const selectedGroups = Array.from(document.querySelectorAll('input[name="groups[]"]:checked'))
				.map(checkbox => checkbox.value);
			
			if (!username || selectedGroups.length === 0) {
				Swal.fire({
					title: 'Erro',
					text: 'Selecione pelo menos um grupo',
					icon: 'error',
					timer: 2000,
					showConfirmButton: false
				});
				return;
			}
			
			fetch('/change_group', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
				},
				body: JSON.stringify({
					change_group_user: username,
					change_group_groups: selectedGroups
				})
			})
			.then(response => response.json())
			.then(data => {
				if (data.success) {
					Swal.fire({
						title: 'Grupos alterados com sucesso',
						icon: 'success',
						timer: 2000,
						showConfirmButton: false
					}).then(() => {
						window.location.reload();
					});
				} else {
					Swal.fire({
						title: 'Erro ao alterar grupos',
						icon: 'error',
						timer: 2000,
						showConfirmButton: false
					});
				}
			})
			.catch(error => console.error('Erro ao alterar grupos:', error));
		}
		
		function lock_user(username) {
			Swal.fire({
				title: 'Desativar usuário',
				html: `Deseja realmente desativar o usuário <b>${username}</b>?`,
				icon: 'warning',
				showCancelButton: true,
				confirmButtonText: 'Sim, desativar',
				cancelButtonText: 'Cancelar'
			}).then((result) => {
				if (result.isConfirmed) {
					fetch('/lock_user', {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json',
						},
						body: JSON.stringify({
							user_to_lock: username
						})
					})
					.then(response => response.json())
					.then(data => {
						if (data.success) {
							Swal.fire({
								title: 'Usuário bloqueado com sucesso',
								icon: 'success',
								timer: 2000,
								showConfirmButton: false
							}).then(() => {
								window.location.reload();
							});
						} else {
							Swal.fire({
								title: 'Erro ao bloquear usuário',
								icon: 'error',
								timer: 2000,
								showConfirmButton: false
							});
						}
					})
					.catch(error => console.error('Erro ao bloquear usuário:', error));
				}
			});
		}
		
		function unlock_user(username) {
			Swal.fire({
				title: 'Ativar usuário',
				html: `Deseja realmente ativar o usuário <b>${username}</b>?`,
				icon: 'warning',
				showCancelButton: true,
				confirmButtonText: 'Sim, ativar',
				cancelButtonText: 'Cancelar'
			}).then((result) => {
				if (result.isConfirmed) {
					fetch('/unlock_user', {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json',
						},
						body: JSON.stringify({
							user_to_unlock: username
						})
					})
					.then(response => response.json())
					.then(data => {
						if (data.success) {
							Swal.fire({
								title: 'Usuário ativado com sucesso',
								icon: 'success',
								timer: 2000,
								showConfirmButton: false
							}).then(() => {
								window.location.reload();
							});
						}
					})	
					.catch(error => console.error('Erro ao ativar usuário:', error));
				}
			});
		}	

		function delete_user(username) {
			Swal.fire({
				title: 'Deletar usuário',
				html: `Deseja realmente deletar o usuário <b>${username}</b>?`,
				icon: 'warning',
				showCancelButton: true,
				confirmButtonText: 'Sim, deletar',
				cancelButtonText: 'Cancelar'
			}).then((result) => {
				if (result.isConfirmed) {
					fetch('/remove_user', {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json',
						},
						body: JSON.stringify({
							user_to_delete: username
						})
					})
					.then(response => response.json())
					.then(data => {
						if (data.success) {
							Swal.fire({
								title: 'Usuário deletado com sucesso',
								icon: 'success',
								timer: 2000,
								showConfirmButton: false
							}).then(() => {
								window.location.reload();
							});
						}
					})
					.catch(error => console.error('Erro ao deletar usuário:', error));
				}
			});
		}

		function loadGroups() {
			fetch('/get_groups')
				.then(response => response.json())
				.then(groups => {
					const groupCheckboxes = document.getElementById('groupCheckboxes');
					groupCheckboxes.innerHTML = ''; // Limpa os checkboxes existentes
					
					groups.forEach(group => {
						const div = document.createElement('div');
						div.className = 'form-check';
						
						div.innerHTML = `
							<input class="form-check-input" type="checkbox" name="groups" value="${group}" id="group_${group}">
							<label class="form-check-label" for="group_${group}">
								${group}
							</label>
						`;
						
						groupCheckboxes.appendChild(div);
					});
				});
		}

		function change_genpass() {
			passGenCaracters = elPassGenRange.value;
			passGenLowercase = elPassGenLowercase.checked;
			passGenUppercase = elPassGenUppercase.checked;
			passGenNumbers = elPassGenNumbers.checked;
			fetch('/set_genpass_config', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
				},
				body: JSON.stringify({
					length: passGenCaracters,
					lowercase: passGenLowercase,
					uppercase: passGenUppercase,
					numbers: passGenNumbers
				})
			}).then(response => response.json())
			.then(data => {
				if (data.success) {
					Swal.fire({
						title: 'Configuração alterada com sucesso',
						icon: 'success',
						timer: 2000,
						showConfirmButton: false
					}).then(() => {
						window.location.reload();
					});
				}
			});
		}
		
		function gerarSenha(element) {

			let senha = '';
			const tamanhoSenha = passGenCaracters;
			
			const caracteres = '';
			if (passGenLowercase){
				caracteres += 'abcdefghijklmnopqrstuvwxyz';
				senha += 'abcdefghijklmnopqrstuvwxyz'.charAt(Math.floor(Math.random() * 26));
			} 
			if (passGenUppercase) {
				caracteres += 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
				senha += 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.charAt(Math.floor(Math.random() * 26));
			}
			if (passGenNumbers) {
				caracteres += '0123456789';
				senha += '0123456789'.charAt(Math.floor(Math.random() * 10));
			}

			// Completa o resto da senha
			for (let i = senha.length; i < tamanhoSenha; i++) {
				senha += caracteres.charAt(Math.floor(Math.random() * caracteres.length));
			}
			
			// Embaralha a senha
			senha = senha.split('').sort(() => Math.random() - 0.5).join('');
			
			// Atualiza o campo de senha
			document.getElementById(element).value = senha;
			
			// Mostra a senha gerada em um alerta
			Swal.fire({
				title: 'Senha Gerada',
				text: senha,
				icon: 'info',
				confirmButtonText: 'Copiar e Fechar',
			}).then((result) => {
				if (result.isConfirmed) {
					navigator.clipboard.writeText(senha);
					Swal.fire({
						title: 'Senha Copiada!',
						icon: 'success',
						timer: 1500,
						showConfirmButton: false
					});
				}
			});
		}
	</script>
</body>
</html>